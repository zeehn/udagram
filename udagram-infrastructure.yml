AWSTemplateFormatVersion: 2010-09-09
Description: Udagram Assignmet Udacity Cloud DevOps Nanadegree Zakir Hussain 2020

Parameters:
  EnvironmentName:
    Description: Name to prefix resources to make them easily identifiable
    Type: String
  VPCCidr:
    Description: Please enter a valid CIDR Block for VPC
    Type: String
  CIDRPublicSubnet1:
    Description: Please enter CIDR Block for Public Subnet 1
    Type: String
  CIDRPublicSubnet2:
    Description: Please enter CIDR Block for Public Subnet 2
    Type: String
  CIDRPrivateSubnet1:
    Description: Please enter CIDR Block for Private Subnet 1
    Type: String
  CIDRPrivateSubnet2:
    Description: Please enter CIDR Block for Private Subnet 2
    Type: String

Resources:
  UdagramVPC:
    Type: AWS::EC2::VPC
    Properties:
      CidrBlock: !Ref VPCCidr
      Tags:
        - Key: Name
          Value: !Sub ${EnvironmentName}-VPC

  UdagramIGW:
    Type: AWS::EC2::InternetGateway
    Properties:
      Tags:
        - Key: Name
          Value: !Sub ${EnvironmentName}-IGW

  VPCIGWAttachment:
    Type: AWS::EC2::VPCGatewayAttachment
    Properties:
      InternetGatewayId: !Ref UdagramIGW
      VpcId: !Ref UdagramVPC

  PublicSubnet1:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref UdagramVPC
      CidrBlock: !Ref CIDRPublicSubnet1
      AvailabilityZone: !Select [0, !GetAZs '']
      Tags:
        - Key: Name
          Value: !Sub ${EnvironmentName} PublicSubnet-1 AZ-1

  PublicSubnet2:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref UdagramVPC
      CidrBlock: !Ref CIDRPublicSubnet2
      AvailabilityZone: !Select [1, !GetAZs '']
      Tags:
        - Key: Name
          Value: !Sub ${EnvironmentName} PublicSubnet-2 AZ-2

  PrivateSubnet1:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref UdagramVPC
      CidrBlock: !Ref CIDRPrivateSubnet1
      AvailabilityZone: !Select [0, !GetAZs '']
      Tags:
        - Key: Name
          Value: !Sub ${EnvironmentName} PrivateSubnet-1 AZ-1

  PrivateSubnet2:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref UdagramVPC
      CidrBlock: !Ref CIDRPrivateSubnet2
      AvailabilityZone: !Select [1, !GetAZs '']
      Tags:
        - Key: Name
          Value: !Sub ${EnvironmentName} PrivateSubnet-2 AZ-2

  NatGateway1EIP:
    Type: AWS::EC2::EIP
    DependsOn: VPCIGWAttachment
    Properties:
      Domain: vpc

  NatGateway2EIP:
    Type: AWS::EC2::EIP
    DependsOn: VPCIGWAttachment
    Properties:
      Domain: vpc

  NatGateway1:
    Type: AWS::EC2::NatGateway
    Properties:
      AllocationId: !GetAtt NatGateway1EIP.AllocationId
      SubnetId: !Ref PublicSubnet1

  NatGateway2:
    Type: AWS::EC2::NatGateway
    Properties:
      AllocationId: !GetAtt NatGateway2EIP.AllocationId
      SubnetId: !Ref PublicSubnet2
